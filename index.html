<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Películas y Series</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Estilo general oscuro */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 2em;
      background-color: #121212;
      color: #e0e0e0;
    }

    h1 {
      color: #ffffff;
      margin-bottom: 1em;
    }

    input, button {
      font-size: 1rem;
      padding: 0.5em;
      margin-right: 0.5em;
      border-radius: 5px;
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: #fff;
    }

    button {
      background-color: #0d6efd;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0b5ed7;
    }

    #movie-info {
      margin-top: 20px;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    img {
      max-width: 200px;
      border-radius: 10px;
      margin-bottom: 1em;
    }

    table {
      width: auto  ;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }

    table td:first-child,
    table th:first-child {
        width: 60px;         /* o incluso 40px */
        max-width: 60px;
        text-align: center;
    }

    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #333;
      color: #fff;
    }

    thead {
      background-color: #2c2c2c;
    }

    .episodio {
      font-weight: bold;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    /* Clases de color por rating */
    .excelente { background-color: #28a745; }   /* ≥ 9 */
    .alta      { background-color: #60d394; }   /* 8 - 8.9 */
    .buena     { background-color: #4dabf7; }   /* 7 - 7.9 */
    .media     { background-color: #facc15; }   /* 5 - 6.9 */
    .baja      { background-color: #fd7e14; }   /* 3 - 4.9 */
    .mala      { background-color: #dc3545; }   /* < 3 */
  </style>
</head>
<body>
  <h1>Buscador de Películas y Series</h1>
  <input id="movie-title" type="text" placeholder="Introduce un título" size="40" />
  <button id="search-button">Buscar</button>

  <div id="movie-info"></div>

  <script>
    $(document).ready(function () {
      $('#search-button').click(function () {
        const title = $('#movie-title').val().trim();
        if (!title) {
          alert('Por favor, introduce un título.');
          return;
        }
        buscarTitulo(title);
      });

      function buscarTitulo(titulo) {
        $.ajax({
          url: 'http://www.omdbapi.com/',
          type: 'GET',
          dataType: 'json',
          data: {
            t: titulo,
            apikey: '35e7d14d'
          },
          success: function (data) {
            mostrarInfo(data);

            if (data.Type === 'series') {
              obtenerTemporadas(data.Title, parseInt(data.totalSeasons));
            }
          },
          error: function (xhr, estado, error) {
            console.error(`Error: ${error} | Estado: ${estado}`);
          }
        });
      }

      function mostrarInfo(data) {
        $('#movie-info').html(`
          <h2>${data.Title}</h2>
          <img src="${data.Poster}" alt="Póster">
          <p><strong>Año:</strong> ${data.Year}</p>
          <p><strong>Género:</strong> ${data.Genre}</p>
          <p><strong>Sinopsis:</strong> ${data.Plot}</p>
          <p><strong>Valoración:</strong> ${data.imdbRating}</p>
        `);
      }

      function obtenerTemporadas(titulo, totalSeasons) {
        const llamadasAjax = [];
        const ratingsPorTemporada = [];
        let maxEpisodios = 0;

        for (let i = 1; i <= totalSeasons; i++) {
          llamadasAjax.push(
            $.ajax({
              url: 'http://www.omdbapi.com/',
              type: 'GET',
              dataType: 'json',
              data: {
                t: titulo,
                Season: i,
                apikey: '35e7d14d'
              },
              success: function (seasonData) {
                ratingsPorTemporada[i] = seasonData.Episodes
                  .map(ep => ep.imdbRating)
                  .filter(rating => !isNaN(parseFloat(rating))); // Solo notas válidas

                if (seasonData.Episodes.length > maxEpisodios) {
                  maxEpisodios = seasonData.Episodes.length;
                }
              }
            })
          );
        }

        $.when.apply($, llamadasAjax).then(function () {
          construirTabla(ratingsPorTemporada, totalSeasons, maxEpisodios);
        });
      }

      function construirTabla(ratings, totalSeasons, maxEpisodios) {
        const tabla = $('<table>');
        const thead = $('<thead><tr><th></th></tr></thead>');
        const tbody = $('<tbody>');

        for (let s = 1; s <= totalSeasons; s++) {
          thead.find('tr').append(`<th>T ${s}</th>`);
        }

        for (let ep = 0; ep < maxEpisodios; ep++) {
          let fila = $('<tr>').append(`<td>${ep + 1}</td>`);
          let tieneRating = false;

          for (let s = 1; s <= totalSeasons; s++) {
            const rating = ratings[s]?.[ep];
            if (rating && !isNaN(parseFloat(rating))) {
              const claseColor = obtenerClasePorRating(rating);
              fila.append(`<td class="episodio ${claseColor}">${rating}</td>`);
              tieneRating = true;
            } else {
              fila.append('<td></td>');
            }
          }

          if (tieneRating) {
            tbody.append(fila);
          }
        }

        tabla.append(thead).append(tbody);
        $('#movie-info').append(tabla);
      }

      function obtenerClasePorRating(rating) {
        const valor = parseFloat(rating);
        if (valor >= 9) return 'excelente';
        if (valor >= 8) return 'alta';
        if (valor >= 7) return 'buena';
        if (valor >= 5) return 'media';
        if (valor >= 3) return 'baja';
        return 'mala';
      }
    });
  </script>
</body>
</html>
